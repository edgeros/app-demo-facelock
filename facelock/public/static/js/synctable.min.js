/*
 * Copyright (c) 2021 EdgerOS Team.
 * All rights reserved.
 *
 * Detailed license information can be found in the LICENSE file.
 *
 * File: synctable.js Web SyncTable client module.
 *
 * Author: Han.hui <hanhui@acoinfo.com>
 * 
 * Version: 0.1.6
 *
 */
!function(){function e(e,s,i){if(e[i]===s)return!1;var r=!1;return"object"==typeof s?null===s?null!==e[i]&&(r=!0):r=Array.isArray(s)?!Array.isArray(e[i])||t(e[i],s):!!Array.isArray(e[i])||t(e[i],s):r=!0,r}function t(t,s){if("object"!=typeof t||"object"!=typeof s)throw new TypeError("Arguments error");if(null==t&&null==s)return!1;if(null==t||null==s)return!0;if(Array.isArray(t)){if(!Array.isArray(s))return!0;var i=!1;try{s.forEach(function(s,r){if(i=e(t,s,r))throw new Error("Different")})}catch(e){if("Different"===e.message)return!0;throw e}}else{if(Array.isArray(s))return!0;i=!1;for(var r in s)if(i=e(t,s[r],r))break}return i}class s{constructor(){this._events={},this.on=this.addEventListener,this.off=this.removeEventListener}_emit(e){var t=this._events[e];if(!Array.isArray(t))return!1;t=t.slice();for(var s=Array.prototype.slice.call(arguments,1),i=0;i<t.length;++i)t[i].apply(this,s);return!0}addEventListener(e,t){if("function"!=typeof t)throw new TypeError("listener must be a function");return this._events[e]||(this._events[e]=[]),this._events[e].push(t),this}removeEventListener(e,t){if("function"!=typeof t)throw new TypeError("listener must be a function");var s=this._events[e];if(!Array.isArray(s))return this;for(var i=s.length-1;i>=0;--i)if(s[i]==t||s[i].listener&&s[i].listener==t){s.splice(i,1),s.length||delete this._events[e];break}return this}removeAllListeners(e){return 0===arguments.length?this._events={}:delete this._events[e],this}}const i=1e3;var r=new Map;class n extends s{constructor(e,t){if("string"!=typeof e||"object"!=typeof t)throw new TypeError("Arguments error");super(),this.ref=1,this.opt=t,this.url=this._url(e,t),this.period=t.ping,this.server=e,this.opened=!1,this.tables=new Map,this.socket=new WebSocket(this.url),this._init(),r.set(e,this)}_url(e,t){var s=e+"/eos/websynctable";return"string"==typeof t.token&&"string"==typeof t.srand?s+=`?edger-token=${t.token}&edger-srand=${t.srand}&version=${o}`:s+=`?version=${o}`,s}_init(){this.socket.onopen=(()=>{this.opened=!0,console.log("SyncTable Linker connected."),this._emit("connect"),null==this.ping&&(this.ping=setInterval(()=>{this.send({event:"noop"})},this.period))}),this.socket.onclose=(()=>{this.opened=!1,this.ref<=0||(console.log("SyncTable Linker disconnect."),this._emit("disconnect"),null!=this.ping&&(clearInterval(this.ping),this.ping=void 0),this._reconn=setTimeout(()=>{this.url=this._url(this.server,this.opt),this.socket=new WebSocket(this.url),this._init()},i))}),this.socket.onmessage=(e=>{try{var t=JSON.parse(e.data)}catch{return console.error("SyncTable Linker receive invalid message.")}var s=this.tables.get(t.name);s?s._onmessage(t):console.warn("SyncTable Linker received unregister table message.")})}close(){this.ref<=0||(this.ref--,this.ref<=0&&(null!=this.ping?(clearInterval(this.ping),this.ping=void 0):clearTimeout(this._reconn),this.removeAllListeners(),this.socket.close(),this.tables.clear(),r.delete(this.server)))}register(e,t){this.tables.set(e,t)}unregister(e){this.tables.delete(e),this.socket.readyState===WebSocket.OPEN&&this.send({name:e,event:"goodbye"})}send(e){return!!this.opened&&(this.socket.send(JSON.stringify(e)),!0)}get state(){return this.socket.readyState}}function h(e){return(new TextEncoder).encode(atob(e))}const o=[0,1,6];var a=new Set;window.SyncTable=class extends s{constructor(e,t,s){if("string"!=typeof e||"string"!=typeof t)throw new TypeError("Arguments error");if(a.has(t))throw new Error("Duplicate creation");var h;"number"!=typeof(s=s||{}).ping&&(s.ping=2e3),"number"!=typeof s.timeout&&(s.timeout=6e3),super(),this._linker=r.get(e),this._linker?this._linker.ref++:this._linker=new n(e,s),this._linker.register(t,this),this._name=t,this._uuid=(h=Date.now(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{var t=(h+16*Math.random())%16|0;return h=Math.floor(h/16),("x"==e?t:3&t|8).toString(16)})),this._scnt=0,this._qsets=[],this._qgets=[],this._qhass=[],this._qcmds=[],this._qsync=[],this._cache=new Map,this._undef=new Set,this._alrdy=void 0,this._init(),this._timer=setInterval(()=>{this._totick(this._qsets,s.timeout),this._totick(this._qgets,s.timeout),this._totick(this._qhass,s.timeout),this._totick(this._qcmds,s.timeout)},i),a.add(t)}_hello(){if(this._qgets.length){var e=[];this._qgets.forEach(t=>e.push(t.key))}else e=void 0;this._qsync.length&&(e=e?e.concat(this._qsync):this._qsync);var t=!1;e&&(this._linker.send(this._bsync(e)),t=!0);for(var s=0;s<this._qsets.length;s++){let e=this._qsets[s];this._linker.send(e.msg),t=!0}for(s=0;s<this._qhass.length;s++){let e=this._qhass[s];this._linker.send(e.msg),t=!0}for(s=0;s<this._qcmds.length;s++){let e=this._qcmds[s];!e.sended&&e.msg&&(this._linker.send(e.msg),e.sended=!0,t=!0)}t||this._linker.send(this._bnoop()),this._emit("connect")}_init(){this._linker.on("connect",()=>{this._hello()}),this._linker.on("disconnect",()=>{this._qsync=[],this._alrdy?this._cache.forEach((e,t)=>this._alrdy.set(t,e)):this._alrdy=this._cache,this._alrdy.forEach((e,t)=>this._qsync.push(t)),this._cache=new Map,this._undef.clear(),this._emit("disconnect")}),this._linker.state===WebSocket.OPEN&&this._hello()}_totick(e,t){for(var s=0;s<e.length;s++){var r=e[s];r.timeout+=i,r.timeout>=t&&(r.reject(new Error("Timeout")),e.splice(s,1),s--)}}_onmessage(e){switch(e.event){case"clear":this._cache.clear(),this._emit("clear");break;case"update":if("base64"===e.encode)try{e.value=h(e.value)}catch{return console.error(`SyncTable: ${this._name} invalid base64.`)}null==e.value?(this._cache.delete(e.key),this._undef.add(e.key)):(this._cache.set(e.key,e.value),this._undef.delete(e.key));for(var s=0;s<this._qgets.length;s++)(n=this._qgets[s]).key===e.key&&(n.resolve(e.value),this._qgets.splice(s,1),s--);if(e.id)for(s=0;s<this._qsets.length;s++)(n=this._qsets[s]).key===e.key&&n.id===e.id&&(n.resolve(e.value),this._qsets.splice(s,1),s--);var i=!0;if(this._alrdy){var r=this._alrdy.get(e.key);r===e.value?i=!1:"object"==typeof r&&"object"==typeof e.value&&(i=t(e.value,r)),void 0!==r&&(this._alrdy.delete(e.key),0===this._alrdy.size&&(this._alrdy=void 0))}i&&this._emit("update",e.key,e.value);break;case"has":for(s=0;s<this._qhass.length;s++)(n=this._qhass[s]).key===e.key&&(null==e.value?this._undef.add(e.key):this._undef.delete(e.key),n.resolve(e.value),this._qhass.splice(s,1),s--);break;case"cmd":for(s=0;s<this._qcmds.length;s++)(n=this._qcmds[s]).key===e.key&&n.id===e.id&&(n.resolve(e.value),this._qcmds.splice(s,1),s--);break;case"event":if("function"==typeof this.onmessage){if("base64"===e.encode)try{e.value=h(e.value)}catch{return console.error(`SyncTable: ${this._name} invalid base64.`)}this.onmessage(e.key,e.value)}break;case"error":if(null!=e.key)if(e.id)for(s=0;s<this._qsets.length;s++)(n=this._qsets[s]).key===e.key&&n.id===e.id&&(n.reject(new Error(e.info)),this._qsets.splice(s,1),s--);else for(s=0;s<this._qgets.length;s++){var n;(n=this._qgets[s]).key===e.key&&(n.reject(new Error(e.info)),this._qgets.splice(s,1),s--)}else console.error(`SyncTable: ${this._name} receive error: ${e.info}`),this._emit("error",new Error(e.info));break;default:console.warn(`SyncTable: ${this._name} receive unknown message: ${e.event}`)}}_genid(){var e=this._uuid+this._scnt;return this._scnt++,e}_bset(e,t,s){var i,r,n={name:this._name,event:"set",id:s,key:e};return t instanceof Uint8Array?(n.encode="base64",n.value=(i=t,r=new TextDecoder("utf8"),btoa(r.decode(i)))):n.value=t,n}_bget(e){return{name:this._name,event:"get",key:e}}_bhas(e){return{name:this._name,event:"has",key:e}}_bsync(e){return{name:this._name,event:"sync",keys:e}}_bcmd(e,t,s){return{name:this._name,event:"cmd",id:s,key:e,value:t}}_bnoop(){return{name:this._name,event:"noop"}}close(){null!=this._cache&&(a.delete(this._name),this.removeAllListeners(),this._linker.unregister(this._name),this._linker.close(),clearInterval(this._timer),delete this._timer,delete this._linker,delete this._name,delete this._cache,delete this._undef,this._totick(this._qsets,0),this._totick(this._qgets,0),this._totick(this._qhass,0),this._totick(this._qcmds,0))}async delete(e){return this.set(e,void 0)}async set(e,t){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("Arguments error");var s=this._bset(e,t,this._genid());return new Promise((t,i)=>{this._linker.opened&&this._linker.send(s),this._qsets.push({key:e,msg:s,id:s.id,timeout:0,resolve:t,reject:i})})}async get(e){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("Arguments error");return new Promise((t,s)=>{var i=this._cache.get(e);null!=i?t(i):this._undef.has(e)?t(i):(this._linker.opened&&this._linker.send(this._bget(e)),this._qgets.push({key:e,timeout:0,resolve:t,reject:s}))})}async has(e){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("Arguments error");var t=this._bhas(e);return new Promise((s,i)=>{var r=this._cache.has(e);r?s(r):this._undef.has(e)?s(!1):(this._linker.opened&&this._linker.send(t),this._qhass.push({key:e,msg:t,timeout:0,resolve:s,reject:i}))})}async fetch(e,t,s=!1,i=0){if("string"!=typeof e)throw new TypeError("Arguments error");"number"!=typeof i&&(i=0);var r=this._bcmd(e,t,this._genid());return new Promise((t,n)=>{this._linker.opened?(this._linker.send(r),this._qcmds.push({key:e,id:r.id,sended:!0,timeout:0-i,resolve:t,reject:n})):s?this._qcmds.push({key:e,msg:r,id:r.id,timeout:0-i,resolve:t,reject:n}):n(new Error("No connection"))})}get name(){return this._name}},window.SyncTable.Object={isDifferent:t}}();
